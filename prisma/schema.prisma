// Prisma schema for Héritier Millionnaire
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  isAdmin      Boolean  @default(false)
  createdAt    DateTime @default(now())
}

model Player {
  id        String   @id @default(cuid())
  nickname  String
  cash      Float    @default(1000000)
  netWorth  Float    @default(1000000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game   Game?   @relation(fields: [gameId], references: [id])
  gameId String?

  // Identifiant invité associé au cookie côté client pour cette partie
  guestId String

  properties PropertyHolding[]
  markets    MarketHolding[]

  @@unique([gameId, guestId])
}

model Game {
  id        String   @id @default(cuid())
  code      String   @unique
  status    String   @default("lobby") // lobby | running | ended
  createdAt DateTime @default(now())
  startedAt DateTime?
  updatedAt DateTime @updatedAt

  players     Player[]
  marketTicks MarketTick[]
  propertyHoldings PropertyHolding[]
  listings    Listing[]
  marketHoldings MarketHolding[]
}

model PropertyTemplate {
  id         String  @id @default(cuid())
  name       String
  city       String
  imageUrl   String
  description String  @default("")
  price      Float
  baseRent   Float
  taxes      Float
  insurance  Float
  maintenance Float
  // Nouvelles méta-infos réalisme (QC)
  units       Int     @default(1)   // nombre de logements
  plumbingState   String @default("bon") // bon | moyen | à rénover
  electricityState String @default("bon")
  roofState       String @default("bon")

  holdings   PropertyHolding[]
  listings   Listing[]
}

model PropertyHolding {
  id           String   @id @default(cuid())
  player       Player   @relation(fields: [playerId], references: [id])
  playerId     String
  template     PropertyTemplate @relation(fields: [templateId], references: [id])
  templateId   String
  game         Game     @relation(fields: [gameId], references: [id])
  gameId       String
  purchasePrice Float
  currentValue  Float
  currentRent   Float
  mortgageRate  Float   @default(0.05)
  mortgageDebt  Float   @default(0)
  weeklyPayment Float   @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  events RepairEvent[]
  refinanceLogs RefinanceLog[]
  listings Listing[]
}

model RepairEvent {
  id         String   @id @default(cuid())
  holding    PropertyHolding @relation(fields: [holdingId], references: [id])
  holdingId  String
  type       String // minor_break | major_break | renovation | bonus
  cost       Float
  impact     String // free text or JSON later
  createdAt  DateTime @default(now())
}

model RefinanceLog {
  id        String   @id @default(cuid())
  holding   PropertyHolding @relation(fields: [holdingId], references: [id])
  holdingId String
  amount    Float
  rate      Float
  at        DateTime @default(now())
}

model Listing {
  id          String   @id @default(cuid())
  game        Game     @relation(fields: [gameId], references: [id])
  gameId      String
  holding     PropertyHolding? @relation(fields: [holdingId], references: [id])
  holdingId   String?
  template    PropertyTemplate? @relation(fields: [templateId], references: [id])
  templateId  String?
  sellerId    String?
  price       Float
  type        String // fixed | auction
  createdAt   DateTime @default(now())
}

model MarketHolding {
  id        String  @id @default(cuid())
  player    Player  @relation(fields: [playerId], references: [id])
  playerId  String
  game      Game    @relation(fields: [gameId], references: [id])
  gameId    String
  symbol    String
  quantity  Float
  avgPrice  Float

  @@unique([playerId, gameId, symbol])
}

model MarketTick {
  id       String  @id @default(cuid())
  game     Game    @relation(fields: [gameId], references: [id])
  gameId   String
  symbol   String
  price    Float
  at       DateTime @default(now())
}
